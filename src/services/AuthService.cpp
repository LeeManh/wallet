
#include "services/AuthService.hpp"

#include <sstream>
#include <tuple>

#include "exceptions/Exception.hpp"
#include "models/User.hpp"
#include "services/OtpService.hpp"
#include "services/UserService.hpp"
#include "services/WalletService.hpp"
#include "utils/ExceptionHandler.hpp"
#include "utils/Hash.hpp"
#include "utils/Input.hpp"
#include "utils/MessageHandler.hpp"
#include "utils/Password.hpp"
#include "utils/Storage.hpp"
#include "utils/Format.hpp"

namespace services {

/**
 * @brief XÃ¡c thá»±c Ä‘Äƒng nháº­p ngÆ°á»i dÃ¹ng.
 *
 * Input:
 *   - username: TÃªn Ä‘Äƒng nháº­p.
 *   - password: Máº­t kháº©u.
 *
 * Output:
 *   - Tráº£ vá» tuple (Ä‘Äƒng nháº­p thÃ nh cÃ´ng?, id ngÆ°á»i dÃ¹ng, cÃ³ pháº£i admin?, máº­t
 * kháº©u tá»± Ä‘á»™ng?).
 *   - NÃ©m AuthException náº¿u tÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng, hoáº·c tÃ i
 * khoáº£n khÃ´ng tá»“n táº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. Äá»c danh sÃ¡ch ngÆ°á»i dÃ¹ng tá»« file users.json.
 *   2. TÃ¬m ngÆ°á»i dÃ¹ng trÃ¹ng username.
 *   3. So khá»›p máº­t kháº©u bÄƒm.
 *   4. Náº¿u há»£p lá»‡, tráº£ vá» thÃ´ng tin Ä‘Äƒng nháº­p; náº¿u sai, nÃ©m ngoáº¡i lá»‡.
 */
std::tuple<bool, int, bool, bool> AuthService::login(
    const std::string& username, const std::string& password) {
  json users = utils::storage::readJsonFile("data/users.json");

  for (const auto& user : users) {
    if (user["username"] == username) {
      bool isMatchPassword =
          utils::hash::validatePassword(password, user["passwordHash"]);
      bool isPasswordAutoGenerated =
          user["isPasswordAutoGenerated"].get<bool>();
      if (!isMatchPassword)
        throw exceptions::AuthException(
            "TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!");

      return {true, user["id"], user["isAdmin"], isPasswordAutoGenerated};
    }
  }

  throw exceptions::AuthException("TÃ i khoáº£n khÃ´ng tá»“n táº¡i");
}

/**
 * @brief ÄÄƒng kÃ½ tÃ i khoáº£n má»›i.
 *
 * Input:
 *   - username: TÃªn Ä‘Äƒng nháº­p.
 *   - password: Máº­t kháº©u.
 *   - email: Äá»‹a chá»‰ email.
 *   - fullName: Há» vÃ  tÃªn Ä‘áº§y Ä‘á»§.
 *
 * Output:
 *   - Tráº£ vá» true náº¿u táº¡o tÃ i khoáº£n vÃ  vÃ­ thÃ nh cÃ´ng.
 *   - NÃ©m ngoáº¡i lá»‡ náº¿u dá»¯ liá»‡u khÃ´ng há»£p lá»‡ hoáº·c táº¡o vÃ­ tháº¥t báº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. Kiá»ƒm tra dá»¯ liá»‡u há»£p lá»‡.
 *   2. Táº¡o ngÆ°á»i dÃ¹ng má»›i.
 *   3. Táº¡o vÃ­ vá»›i sá»‘ dÆ° ban Ä‘áº§u = 0.
 *   4. Náº¿u lá»—i khi táº¡o vÃ­, rollback vÃ  nÃ©m ngoáº¡i lá»‡.
 */
bool AuthService::registerUser(const std::string& username,
                               const std::string& password,
                               const std::string& email,
                               const std::string& fullName) {
  // Validate data
  UserService::validateUserData(username, email);

  // Táº¡o user má»›i
  models::User newUser =
      UserService::createUser(username, password, email, fullName);

  // Tá»± Ä‘á»™ng táº¡o vÃ­ cho user má»›i
  try {
    WalletService::createWallet(newUser.getId(), 0.0);
  } catch (const std::exception& e) {
    // Rollback user creation
    UserService::deleteUser(newUser.getId());

    throw;
  }

  return true;
}

/**
 * @brief Táº¡o má»›i má»™t ngÆ°á»i dÃ¹ng bá»Ÿi admin vÃ  gÃ¡n máº­t kháº©u ngáº«u nhiÃªn.
 *
 * Input:
 *   - username: TÃªn Ä‘Äƒng nháº­p.
 *   - email: Äá»‹a chá»‰ email.
 *   - fullName: Há» vÃ  tÃªn Ä‘áº§y Ä‘á»§.
 *   - generatedPassword: Biáº¿n tham chiáº¿u Ä‘á»ƒ tráº£ máº­t kháº©u tá»± sinh.
 *
 * Output:
 *   - Tráº£ vá» true náº¿u táº¡o tÃ i khoáº£n vÃ  vÃ­ thÃ nh cÃ´ng.
 *   - NÃ©m ngoáº¡i lá»‡ náº¿u dá»¯ liá»‡u khÃ´ng há»£p lá»‡ hoáº·c táº¡o vÃ­ tháº¥t báº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. Kiá»ƒm tra dá»¯ liá»‡u há»£p lá»‡.
 *   2. Sinh máº­t kháº©u ngáº«u nhiÃªn 8 kÃ½ tá»±.
 *   3. Táº¡o tÃ i khoáº£n.
 *   4. Táº¡o vÃ­ sá»‘ dÆ° = 0.
 *   5. Náº¿u lá»—i khi táº¡o vÃ­, rollback vÃ  nÃ©m ngoáº¡i lá»‡.
 */
bool AuthService::registerUserByAdmin(const std::string& username,
                                      const std::string& email,
                                      const std::string& fullName,
                                      std::string& generatedPassword) {
  // Validate data
  UserService::validateUserData(username, email);

  // Táº¡o user má»›i
  generatedPassword = utils::password::generateRandomPassword(8);
  models::User newUser = UserService::createUser(username, generatedPassword,
                                                 email, fullName, false, true);

  // Tá»± Ä‘á»™ng táº¡o vÃ­ cho user má»›i
  try {
    WalletService::createWallet(newUser.getId(), 0.0);
  } catch (const std::exception& e) {
    // Rollback user creation
    UserService::deleteUser(newUser.getId());

    throw;
  }

  return true;
}

/**
 * @brief XÃ¡c thá»±c OTP khi thay Ä‘á»•i thÃ´ng tin ngÆ°á»i dÃ¹ng.
 *
 * Input:
 *   - userId: ID ngÆ°á»i dÃ¹ng.
 *   - email: Email Ä‘á»ƒ gá»­i OTP.
 *
 * Output: KhÃ´ng tráº£ vá» giÃ¡ trá»‹, nÃ©m ngoáº¡i lá»‡ náº¿u OTP khÃ´ng há»£p lá»‡.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. Gá»­i OTP Ä‘áº¿n email ngÆ°á»i dÃ¹ng.
 *   2. YÃªu cáº§u nháº­p OTP tá»« bÃ n phÃ­m.
 *   3. XÃ¡c minh OTP.
 */
void AuthService::otpValidation(const int userId, const std::string& email) {
  // Input OTP
  utils::MessageHandler::logMessage("Gá»­i mÃ£ OTP Ä‘á»ƒ xÃ¡c thá»±c...");
  services::OtpService::generateAndSendOTP(userId, email,
                                           enums::OTPType::INFO_CHANGE);

  // Táº¡o vÃ  xÃ¡c minh OTP
  std::string otpCode = utils::input::getInput("Nháº­p mÃ£ OTP Ä‘Ã£ Ä‘Æ°á»£c gá»­i: ");
  utils::MessageHandler::logMessage(
      "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

  services::OtpService::verifyOTP(userId, otpCode, enums::OTPType::INFO_CHANGE);
}

/**
 * @brief Chá»‰nh sá»­a thÃ´ng tin cÃ¡ nhÃ¢n cá»§a ngÆ°á»i dÃ¹ng.
 *
 * Input:
 *   - userId: ID ngÆ°á»i dÃ¹ng.
 *   - newFullName: Há» tÃªn má»›i (cÃ³ thá»ƒ bá» trá»‘ng).
 *   - newEmail: Email má»›i (cÃ³ thá»ƒ bá» trá»‘ng).
 *
 * Output:
 *   - Tráº£ vá» true náº¿u cáº­p nháº­t thÃ nh cÃ´ng.
 *   - NÃ©m NotFoundException náº¿u user khÃ´ng tá»“n táº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. XÃ¡c thá»±c email má»›i (náº¿u cÃ³).
 *   2. TÃ¬m user trong file users.json.
 *   3. Náº¿u cÃ³ há» tÃªn má»›i hoáº·c email má»›i:
      - Hiá»ƒn thá»‹ danh sÃ¡ch thay Ä‘á»•i
      - Gá»­i OTP xÃ¡c nháº­n thay Ä‘á»•i.
 *   4. Náº¿u OTP xÃ¡c thá»±c thÃ nh cÃ´ng, lÆ°u thay Ä‘á»•i vÃ o file.
 */
bool AuthService::editUserInfo(int userId, const std::string& newFullName,
                               const std::string& newEmail) {
  // Validate new email
  if (!newEmail.empty()) {
    UserService::validateUserEmail(userId, newEmail);
  }

  json users = utils::storage::readJsonFile("data/users.json");
  bool found = false;

  for (auto& user : users) {
    if (user["id"] == userId) {
      std::string oldFullName = user["fullName"];
      std::string oldEmail = user["email"];

      // XÃ¢y dá»±ng thÃ´ng bÃ¡o thay Ä‘á»•i
      std::ostringstream changeMsg;
      bool hasChange = false;
      const int fieldWidth = 10;
      const int valueWidth = 40;

      changeMsg << "ğŸ”„ CÃ¡c thay Ä‘á»•i:\n";
      changeMsg << "+" << std::string(fieldWidth+2, '-') << "+"
                << std::string(valueWidth+2, '-') << "+\n";
      changeMsg << "| " << utils::format::padRight("TrÆ°á»ng", fieldWidth)
                << " | " << utils::format::padRight("Thay Ä‘á»•i", valueWidth) << " |\n";
      changeMsg << "+" << std::string(fieldWidth+2, '-') << "+"
                << std::string(valueWidth+2, '-') << "+\n";

      // Há» tÃªn
      if (!newFullName.empty() && newFullName != oldFullName) {
        std::string change = oldFullName + " â†’ " + newFullName;
        auto lines = utils::format::wrapText(change, valueWidth);
        changeMsg << "| " << utils::format::padRight("Há» tÃªn", fieldWidth) << " | "
                  << utils::format::padRight(lines[0], valueWidth) << " |\n";
        for (size_t i = 1; i < lines.size(); ++i) {
          changeMsg << "| " << utils::format::padRight("", fieldWidth) << " | "
                    << utils::format::padRight(lines[i], valueWidth) << " |\n";
        }
        changeMsg << "+" << std::string(fieldWidth+2, '-') << "+"
                  << std::string(valueWidth+2, '-') << "+\n";
        hasChange = true;
      }
      // Email
      if (!newEmail.empty() && newEmail != oldEmail) {
        std::string change = oldEmail + " â†’ " + newEmail;
        auto lines = utils::format::wrapText(change, valueWidth);
        changeMsg << "| " << utils::format::padRight("Email", fieldWidth) << " | "
                  << utils::format::padRight(lines[0], valueWidth) << " |\n";
        for (size_t i = 1; i < lines.size(); ++i) {
          changeMsg << "| " << utils::format::padRight("", fieldWidth) << " | "
                    << utils::format::padRight(lines[i], valueWidth) << " |\n";
        }
        changeMsg << "+" << std::string(fieldWidth+2, '-') << "+"
                  << std::string(valueWidth+2, '-') << "+\n";
        hasChange = true;
      }

      // Náº¿u cÃ³ thay Ä‘á»•i, gá»­i OTP xÃ¡c nháº­n
      if (hasChange) {
        utils::MessageHandler::logMessage(
            "Há»‡ thá»‘ng sáº½ cáº­p nháº­t thÃ´ng tin sau khi báº¡n xÃ¡c nháº­n OTP.\n");
        utils::MessageHandler::logMessage(changeMsg.str());
        otpValidation(userId, user["email"]);
      }
      // Cáº­p nháº­t thÃ´ng tin má»›i náº¿u Ä‘Ã£ xÃ¡c thá»±c OTP thÃ nh cÃ´ng
      if (!newFullName.empty()) {
        user["fullName"] = newFullName;
      }
      if (!newEmail.empty()) {
        user["email"] = newEmail;
      }
      found = true;
      break;
    }
  }

  if (!found) {
    throw exceptions::NotFoundException("User khÃ´ng tá»“n táº¡i");
  }

  utils::storage::writeJsonFile("data/users.json", users);
  return true;
}

/**
 * @brief Äá»•i máº­t kháº©u ngÆ°á»i dÃ¹ng.
 *
 * Input:
 *   - userId: ID ngÆ°á»i dÃ¹ng.
 *   - currentPassword: Máº­t kháº©u hiá»‡n táº¡i.
 *   - newPassword: Máº­t kháº©u má»›i.
 *
 * Output:
 *   - Tráº£ vá» true náº¿u Ä‘á»•i thÃ nh cÃ´ng.
 *   - NÃ©m ngoáº¡i lá»‡ náº¿u máº­t kháº©u hiá»‡n táº¡i sai hoáº·c user khÃ´ng tá»“n táº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. TÃ¬m user theo ID.
 *   2. So khá»›p máº­t kháº©u hiá»‡n táº¡i.
 *   3. Náº¿u Ä‘Ãºng, gá»i updateUserPassword.
 */
bool AuthService::changePassword(int userId, const std::string& currentPassword,
                                 const std::string& newPassword) {
  auto userJson = UserService::findUserById(userId);

  if (!userJson.has_value())
    throw exceptions::NotFoundException("User khÃ´ng tá»“n táº¡i");

  // Kiá»ƒm tra máº­t kháº©u cÃ³ Ä‘Ãºng khÃ´ng
  bool isMatchPassword = utils::hash::validatePassword(
      currentPassword, userJson.value()["passwordHash"]);
  if (!isMatchPassword)
    throw exceptions::ValidationException("Máº­t kháº©u hiá»‡n táº¡i khÃ´ng Ä‘Ãºng!");

  return updateUserPassword(userId, newPassword);
}

/**
 * @brief Cáº­p nháº­t máº­t kháº©u má»›i cho ngÆ°á»i dÃ¹ng.
 *
 * Input:
 *   - userId: ID ngÆ°á»i dÃ¹ng.
 *   - newPassword: Máº­t kháº©u má»›i.
 *
 * Output:
 *   - Tráº£ vá» true náº¿u cáº­p nháº­t thÃ nh cÃ´ng.
 *   - NÃ©m NotFoundException náº¿u user khÃ´ng tá»“n táº¡i.
 *
 * Thá»§ tá»¥c xá»­ lÃ½:
 *   1. Äá»c danh sÃ¡ch user tá»« file.
 *   2. TÃ¬m user theo ID.
 *   3. Hash máº­t kháº©u má»›i, cáº­p nháº­t cá» isPasswordAutoGenerated = false.
 *   4. LÆ°u láº¡i file.
 */
bool AuthService::updateUserPassword(int userId,
                                     const std::string& newPassword) {
  json users = utils::storage::readJsonFile("data/users.json");

  for (auto& user : users) {
    if (user["id"] == userId) {
      user["passwordHash"] = utils::hash::generatePasswordHash(newPassword);
      user["isPasswordAutoGenerated"] = false;

      utils::storage::writeJsonFile("data/users.json", users);

      return true;
    }
  }

  throw exceptions::NotFoundException("User khÃ´ng tá»“n táº¡i");
}

}  // namespace services